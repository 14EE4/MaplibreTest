<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Raster Map (노트 기능)</title>
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.11.0/dist/maplibre-gl.css" />
    <script src="https://unpkg.com/maplibre-gl@5.11.0/dist/maplibre-gl.js"></script>
    <style>
        html, body, #map { height: 100%; margin: 0; padding: 0; }
        .popup-input textarea { width: 220px; height: 80px; }
        .popup-input button { margin-right: 6px; }
        .popup-note p { margin: 6px 0 0 0; }
        .popup-meta { font-size: 11px; color: #666; margin-top:6px; }
    </style>
</head>
<body>
<div id="map"></div>
<script>
console.log('rasterMap.html loaded');

const map = new maplibregl.Map({
    container: 'map',
    style: {
        version: 8,
        sources: {
            'raster-tiles': {
                type: 'raster',
                tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                tileSize: 256,
                minzoom: 0,
                maxzoom: 19
            }
        },
        layers: [{ id: 'simple-tiles', type: 'raster', source: 'raster-tiles', attribution: '© OpenStreetMap contributors' }]
    },
    center: [0, 0],
    zoom: 0
});

try { map.getCanvas().style.cursor = 'crosshair'; } catch (e) { console.warn('cursor set failed', e); }

// Note UI state
var popups = [];
var seenNoteIds = {};
var activeInputPopup = null;

function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

function removePopupFromArray(popup) {
    var idx = popups.indexOf(popup);
    if (idx !== -1) popups.splice(idx, 1);
    if (activeInputPopup === popup) activeInputPopup = null;
}

function tryAttachCloseListener(popup) {
    try {
        var el = (typeof popup.getElement === 'function') ? popup.getElement() : (popup._container || null);
        if (el) {
            var closeBtn = el.querySelector && el.querySelector('.maplibregl-popup-close-button');
            if (closeBtn) {
                var handler = function() { removePopupFromArray(popup); closeBtn.removeEventListener('click', handler); };
                closeBtn.addEventListener('click', handler);
            }
        }
    } catch (err) { /* best-effort */ }
}

function makeReadonlyHtml(n) {
    var html = '<div class="popup-note"><strong>메모</strong><p>' + (escapeHtml(n.content || '').replace(/\n/g, '<br>') || '<em>내용 없음</em>') + '</p>';
    if (n.createdAt) html += '<div class="popup-meta">등록: ' + escapeHtml(n.createdAt) + '</div>';
    if (n.id != null) html += '<div style="margin-top:6px"><button class="popup-edit-btn" type="button">수정</button> <button class="popup-delete-btn" type="button">삭제</button></div>';
    html += '</div>';
    return html;
}

function loadNotes() {
    fetch('/api/notes').then(r => r.json()).then(function(notes) {
        notes.forEach(function(n) {
            if (n.id != null && seenNoteIds[n.id]) return;
            var html = makeReadonlyHtml(n);
            var p = new maplibregl.Popup({ closeOnClick: false }).setLngLat([n.lng, n.lat]).setHTML(html).addTo(map);
            if (n.id != null) p.noteId = n.id;
            popups.push(p);
            if (n.id != null) seenNoteIds[n.id] = true;
            tryAttachCloseListener(p);
            attachEditListener(p, n);
        });
    }).catch(function(err){ console.warn('loadNotes failed', err); });
}

function pollNotes() {
    fetch('/api/notes').then(r => r.json()).then(function(notes) {
        notes.forEach(function(n) {
            if (n.id == null) return;
            if (seenNoteIds[n.id]) return;
            var html = makeReadonlyHtml(n);
            var p = new maplibregl.Popup({ closeOnClick: false }).setLngLat([n.lng, n.lat]).setHTML(html).addTo(map);
            p.noteId = n.id;
            popups.push(p);
            seenNoteIds[n.id] = true;
            tryAttachCloseListener(p);
            attachEditListener(p, n);
        });
    }).catch(function(err){ console.warn('pollNotes failed', err); });
}

// open an editor popup for an existing note
function openEditPopupForNote(popupRef, note) {
    console.debug('openEditPopupForNote', note && note.id);
    if (!note || note.id == null) return;
    if (activeInputPopup) { try { activeInputPopup.remove(); } catch (e) {} removePopupFromArray(activeInputPopup); activeInputPopup = null; }

    var container = document.createElement('div');
    container.className = 'popup-input';

    var info = document.createElement('div');
    info.style.marginBottom = '6px';
    info.innerHTML = '<strong>위치</strong><br>경도: ' + (note.lng || '') + '<br>위도: ' + (note.lat || '');
    container.appendChild(info);

    var textarea = document.createElement('textarea');
    textarea.placeholder = '여기에 메모를 입력하세요...';
    textarea.value = note.content || '';
    container.appendChild(textarea);

    var buttons = document.createElement('div'); buttons.style.marginTop = '6px';
    var saveBtn = document.createElement('button'); saveBtn.type = 'button'; saveBtn.textContent = '저장'; buttons.appendChild(saveBtn);
    var cancelBtn = document.createElement('button'); cancelBtn.type = 'button'; cancelBtn.textContent = '취소'; buttons.appendChild(cancelBtn);
    container.appendChild(buttons);

    var editorPopup = new maplibregl.Popup({ closeOnClick: false }).setLngLat([note.lng, note.lat]).setDOMContent(container).addTo(map);
    popups.push(editorPopup); activeInputPopup = editorPopup; textarea.focus();

    saveBtn.addEventListener('click', function() {
        var text = textarea.value.trim();
        var payload = { id: note.id, lng: parseFloat(note.lng), lat: parseFloat(note.lat), content: text };
        fetch('/api/notes', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
            .then(r => { if (!r.ok) throw new Error('update failed'); return r.json(); })
            .then(function(saved) {
                var html = makeReadonlyHtml({ id: saved.id || note.id, lng: saved.lng || note.lng, lat: saved.lat || note.lat, content: saved.content || text, createdAt: saved.createdAt || note.createdAt });
                if (popupRef && typeof popupRef.setHTML === 'function') { popupRef.setHTML(html); tryAttachCloseListener(popupRef); }
                try { editorPopup.remove(); } catch (e) {} removePopupFromArray(editorPopup); activeInputPopup = null;
                // reattach edit listener to updated popup
                if (popupRef) attachEditListener(popupRef, { id: saved.id || note.id, lng: saved.lng || note.lng, lat: saved.lat || note.lat, content: saved.content || text, createdAt: saved.createdAt || note.createdAt });
            }).catch(function(err){ console.error('update error', err); alert('저장에 실패했습니다. 콘솔 확인'); });
    });

    cancelBtn.addEventListener('click', function() { try { editorPopup.remove(); } catch (e) {} removePopupFromArray(editorPopup); if (activeInputPopup === editorPopup) activeInputPopup = null; });
}

// attach a click listener to popup's edit button (or content as fallback)
function attachEditListener(popup, note) {
    var attempts = 0;
    function tryAttach() {
        attempts++;
        try {
            var el = (typeof popup.getElement === 'function') ? popup.getElement() : (popup._container || null);
            if (!el) { if (attempts < 10) return setTimeout(tryAttach, 100); return; }
            // attach delete button if present
            var delBtn = el.querySelector && el.querySelector('.popup-delete-btn');
            if (delBtn && !delBtn.__hasDeleteListener) {
                delBtn.__hasDeleteListener = true;
                delBtn.addEventListener('click', function(ev) {
                    try { ev.stopPropagation(); ev.preventDefault(); } catch (e) {}
                    if (!note || note.id == null) return;
                    if (!confirm('정말로 이 노트를 삭제하시겠습니까?')) return;
                    fetch('/api/notes/' + encodeURIComponent(note.id), { method: 'DELETE' })
                        .then(function(res) {
                            if (!res.ok) throw new Error('삭제 실패');
                            try { if (popup) popup.remove(); } catch (e) {}
                            removePopupFromArray(popup);
                            if (note && note.id != null) delete seenNoteIds[note.id];
                        })
                        .catch(function(err) { console.error('삭제 오류', err); alert('삭제에 실패했습니다. 콘솔을 확인하세요.'); });
                });
                // continue to attach edit listener if delete attached
            }
            // existing edit button logic
            var btn = el.querySelector && el.querySelector('.popup-edit-btn');
            if (btn && !btn.__hasEditListener) { btn.__hasEditListener = true; btn.addEventListener('click', function(ev){ try { ev.stopPropagation(); ev.preventDefault(); } catch(e) {} openEditPopupForNote(popup, note); }); return; }
            var targetEl = el.querySelector && el.querySelector('.maplibregl-popup-content') || el;
            if (!targetEl) { if (attempts < 10) return setTimeout(tryAttach, 100); return; }
            if (targetEl.__hasEditListener) return; targetEl.__hasEditListener = true;
            targetEl.addEventListener('click', function(ev) { if (ev.target && ev.target.closest && ev.target.closest('.maplibregl-popup-close-button')) return; try { ev.stopPropagation(); ev.preventDefault(); } catch(e) {} openEditPopupForNote(popup, note); });
        } catch (err) { if (attempts < 10) return setTimeout(tryAttach, 100); }
    }
    tryAttach();
}

map.on('load', function() { console.log('map loaded'); loadNotes(); setInterval(pollNotes, 10000); });

map.on('click', function(e) {
    try { console.log('map click', e && e.lngLat ? e.lngLat : e); } catch (err) {}
    var lng = e.lngLat.lng.toFixed(6), lat = e.lngLat.lat.toFixed(6);
    if (activeInputPopup) { try { activeInputPopup.remove(); } catch (e) {} removePopupFromArray(activeInputPopup); activeInputPopup = null; }

    var container = document.createElement('div'); container.className = 'popup-input';
    var info = document.createElement('div'); info.style.marginBottom = '6px'; info.innerHTML = '<strong>위치</strong><br>경도: ' + lng + '<br>위도: ' + lat; container.appendChild(info);
    var textarea = document.createElement('textarea'); textarea.placeholder = '여기에 메모를 입력하세요...'; container.appendChild(textarea);
    var buttons = document.createElement('div'); buttons.style.marginTop = '6px';
    var saveBtn = document.createElement('button'); saveBtn.type = 'button'; saveBtn.textContent = '저장'; buttons.appendChild(saveBtn);
    var cancelBtn = document.createElement('button'); cancelBtn.type = 'button'; cancelBtn.textContent = '취소'; buttons.appendChild(cancelBtn);
    container.appendChild(buttons);

    var thisPopup = new maplibregl.Popup({ closeOnClick: false }).setLngLat(e.lngLat).setDOMContent(container).addTo(map);
    popups.push(thisPopup); activeInputPopup = thisPopup; textarea.focus();

    saveBtn.addEventListener('click', function() {
        var text = textarea.value.trim();
        var payload = { lng: parseFloat(lng), lat: parseFloat(lat), content: text };
        fetch('/api/notes', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
            .then(r => { if (!r.ok) throw new Error('save failed'); return r.json(); })
            .then(function(saved) {
                var id = (saved && saved.id != null) ? saved.id : null;
                var createdAt = (saved && saved.createdAt) ? saved.createdAt : null;
                var html = makeReadonlyHtml({ id: id, lng: lng, lat: lat, content: saved && saved.content ? saved.content : text, createdAt: createdAt });
                thisPopup.setHTML(html);
                if (id != null) { thisPopup.noteId = id; seenNoteIds[id] = true; }
                if (activeInputPopup === thisPopup) activeInputPopup = null;
                tryAttachCloseListener(thisPopup);
                attachEditListener(thisPopup, { id: id, lng: parseFloat(lng), lat: parseFloat(lat), content: saved && saved.content ? saved.content : text, createdAt: createdAt });
            }).catch(function(err){ console.error('save error', err); alert('저장 실패'); });
    });

    cancelBtn.addEventListener('click', function() { try { thisPopup.remove(); } catch (e) {} removePopupFromArray(thisPopup); if (activeInputPopup === thisPopup) activeInputPopup = null; });
});

</script>
</body>
</html>