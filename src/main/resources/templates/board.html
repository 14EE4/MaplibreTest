<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>게시판 보기</title>
    <style>
        body { font-family: Arial, Helvetica, sans-serif; margin: 16px; }
        h1 { margin-top: 0; }
        .meta { color: #666; font-size: 13px; margin-bottom: 8px; }
        #posts { margin-top: 12px; }
        .post { border: 1px solid #ddd; padding: 8px; border-radius: 6px; margin-bottom: 8px; }
        .post .time { color: #888; font-size: 12px; }
        #newPost { margin-top: 16px; }
        #newPost textarea { width: 100%; height: 100px; }
        #newPost button { margin-top: 8px; }
        .notice { background:#fffbdd;border:1px solid #ffe58f;padding:8px;border-radius:4px;margin-bottom:12px }
    </style>
</head>
<body>
    <h1 id="title">게시판</h1>
    <div id="boardMeta" class="meta">로드 중...</div>

    <div class="notice">
        이 페이지는 클라이언트에서 보드 ID 또는 격자 좌표로 게시글을 불러옵니다.<br>
        URL 예시: <code>/boards?id=123</code> 또는 <code>/boards?grid_x=0&grid_y=0</code>
    </div>

    <div id="posts"></div>

    <div id="newPost">
        <h3>새 글 작성</h3>
        <input id="author" placeholder="작성자 (선택)" style="width:100%; padding:6px; box-sizing:border-box; margin-bottom:6px" />
        <textarea id="content" placeholder="내용을 입력하세요..."></textarea>
        <br>
        <button id="submitPost">전송</button>
    </div>

<script>
(function(){
    function qs(name) { 
        const urlParams = new URLSearchParams(window.location.search); return urlParams.get(name);
    }

    const boardIdParam = qs('id');
    const gridX = qs('grid_x');
    const gridY = qs('grid_y');

    let resolvedBoardId = null;
    const titleEl = document.getElementById('title');
    const metaEl = document.getElementById('boardMeta');
    const postsEl = document.getElementById('posts');
    const submitBtn = document.getElementById('submitPost');

    function formatTime(ts) {
        if (!ts) return '';
        try { const d = new Date(ts); return d.toLocaleString(); } catch(e) { return ts; }
    }

    function renderPosts(list) {
        postsEl.innerHTML = '';
        if (!list || !list.length) { postsEl.innerHTML = '<div class="meta">게시글이 없습니다.</div>'; return; }
        list.forEach(function(p){
            const div = document.createElement('div'); div.className = 'post';
            const head = document.createElement('div'); head.innerHTML = (p.author?('<strong>'+escapeHtml(p.author)+'</strong>'):'<strong>익명</strong>') + ' <span class="time">' + (p.createdAt?formatTime(p.createdAt):'') + '</span>';
            const body = document.createElement('div'); body.style.marginTop = '6px'; body.innerHTML = '<div>' + escapeHtml((p.content||'')).replace(/\n/g,'<br>') + '</div>';
            div.appendChild(head); div.appendChild(body);
            postsEl.appendChild(div);
        });
    }

    function escapeHtml(str) { if (!str) return ''; return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    function loadBoardById(id) {
        metaEl.textContent = '게시판 로드 중...';
        // optional: load one board metadata if API exists (GET /api/boards/{id})
        // We'll attempt to load posts directly.
        resolvedBoardId = id;
        titleEl.textContent = '게시판 #' + id;
        metaEl.textContent = '';
        loadPosts();
    }

    function loadBoardByGrid(x,y) {
        metaEl.textContent = '격자 보드 조회 중...';
        fetch('/api/boards').then(r => r.json()).then(function(list){
            var found = null;
            list.forEach(function(b){ if (b.grid_x == x && b.grid_y == y) found = b; });
            if (found) { titleEl.textContent = found.name || ('Board '+found.id); metaEl.textContent = 'grid: '+x+','+y; resolvedBoardId = found.id; loadPosts(); }
            else { metaEl.textContent = '해당 격자의 게시판을 찾을 수 없습니다 (grid:'+x+','+y+').'; }
        }).catch(function(err){ console.error('boards fetch failed', err); metaEl.textContent = '보드 목록을 불러오지 못했습니다. 콘솔 확인'; });
    }

    function loadPosts() {
        if (!resolvedBoardId) return;
        fetch('/api/boards/' + encodeURIComponent(resolvedBoardId) + '/posts').then(r => r.json()).then(function(list){ renderPosts(list); }).catch(function(err){ console.error('posts fetch failed', err); metaEl.textContent = '게시글을 불러오지 못했습니다. 콘솔 확인'; });
    }

    submitBtn.addEventListener('click', function(){
        if (!resolvedBoardId) { alert('게시판이 선택되지 않았습니다. URL에 id 또는 grid_x/grid_y를 지정하세요.'); return; }
        var author = document.getElementById('author').value.trim();
        var content = document.getElementById('content').value.trim();
        if (!content) { alert('내용을 입력하세요.'); return; }
        var payload = { author: author || null, content: content };
        fetch('/api/boards/' + encodeURIComponent(resolvedBoardId) + '/posts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
            .then(function(res){ if (!res.ok) throw new Error('post failed'); return res.json(); })
            .then(function(saved){ document.getElementById('content').value = ''; loadPosts(); })
            .catch(function(err){ console.error('post failed', err); alert('작성 실패. 콘솔을 확인하세요.'); });
    });

    // entry
    if (boardIdParam) { loadBoardById(boardIdParam); }
    else if (gridX != null && gridY != null) { loadBoardByGrid(gridX, gridY); }
    else { metaEl.textContent = 'URL에 ?id=BOARD_ID 또는 ?grid_x=NUM&grid_y=NUM 를 추가하세요.'; }
})();
</script>
</body>
</html>